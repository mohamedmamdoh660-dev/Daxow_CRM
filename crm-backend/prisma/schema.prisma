generator client {
  provider = "prisma-client-js"
}

generator client_frontend {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model FieldDefinition {
  id           String   @id @default(cuid())
  module       String
  apiName      String
  label        String
  fieldType    String
  isRequired   Boolean  @default(false)
  isIndexed    Boolean  @default(false)
  options      Json?
  placeholder  String?
  helpText     String?
  validation   Json?
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([module, apiName])
  @@index([module, isActive])
}

model Country {
  id                    String   @id @default(cuid())
  name                  String   @unique
  code                  String   @unique
  phoneCode             String?
  region                String   @default("Other")
  activeOnNationalities Boolean  @default(true)
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  cities                City[]

  @@index([code])
  @@index([activeOnNationalities])
  programs Program[]
}

model City {
  id        String   @id @default(cuid())
  name      String
  countryId String
  country   Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryId])
  programs  Program[]
}

model AcademicYear {
  id        String     @id @default(cuid())
  name      String     @unique
  isDefault Boolean    @default(false)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Semester {
  id        String   @id @default(cuid())
  name      String
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Faculty {
  id          String      @id @default(cuid())
  name        String      @unique
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  specialties Specialty[]
  programs    Program[]
}

model Title {
  id        String      @id @default(cuid())
  name      String      @unique
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Specialty {
  id        String         @id @default(cuid())
  name      String         @unique
  facultyId String
  faculty   Faculty        @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([facultyId])
  programs  Program[]
}

model Language {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  programs  Program[]
}

model Degree {
  id           String   @id @default(cuid())
  name         String   @unique
  code         String?
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive, displayOrder])
  programs     Program[]
}

model Program {
  id                 String   @id @default(cuid())
  
  // Relations
  facultyId          String
  specialtyId        String
  degreeId           String
  languageId         String
  countryId          String?
  cityId             String?
  userId             String?

  // Basic Info
  name               String
  isActive           Boolean  @default(false)
  activeApplications Boolean  @default(false)
  studyYears         String?

  // Financials
  officialTuition    Decimal? @db.Decimal(10, 2)
  discountedTuition  Decimal? @db.Decimal(10, 2)
  tuitionCurrency    String?  @default("USD")

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  faculty            Faculty   @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  specialty          Specialty @relation(fields: [specialtyId], references: [id])
  degree             Degree    @relation(fields: [degreeId], references: [id])
  languageRel        Language  @relation(fields: [languageId], references: [id])
  country            Country?  @relation(fields: [countryId], references: [id])
  city               City?     @relation(fields: [cityId], references: [id])
  user               User?      @relation(fields: [userId], references: [id])

  applications       Application[]

  @@index([facultyId])
  @@index([specialtyId])
  @@index([degreeId])
  @@index([languageId])
  @@index([countryId])
  @@index([cityId])
  @@index([userId])
}

model Agent {
  id             String    @id @default(cuid())
  companyName    String
  contactPerson  String?
  email          String?   @unique
  phone          String?
  commissionRate Decimal?  @db.Decimal(5, 2)
  country        String?
  city           String?
  address        String?
  metadata       Json      @default("{}")
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  students       Student[]
  users          User[]
  
  @@index([email])
  @@index([country])
}

model Student {
  id                 String          @id @default(cuid())
  studentId          String?         @unique  // STU-0001, STU-0002, etc.
  transferStudent    Boolean         @default(false)
  haveTc             Boolean?
  tcNumber           String?
  blueCard           Boolean         @default(false)
  firstName          String
  lastName           String
  fullName           String
  gender             String?
  dateOfBirth        DateTime?
  nationality        String?
  passportNumber     String?         @unique
  passportIssueDate  DateTime?
  passportExpiryDate DateTime?
  email              String          @unique
  phone              String?
  mobile             String?
  addressLine1       String?
  cityDistrict       String?
  stateProvince      String?
  postalCode         String?
  addressCountry     String?
  fatherName         String?
  fatherMobile       String?
  fatherOccupation   String?
  motherName         String?
  motherMobile       String?
  motherOccupation   String?
  educationLevelId   String?
  educationLevelName String?
  highSchoolCountry  String?
  highSchoolName     String?
  highSchoolGpa      Decimal?        @db.Decimal(5, 2)
  bachelorCountry    String?
  bachelorSchoolName String?
  bachelorGpa        Decimal?        @db.Decimal(5, 2)
  masterCountry      String?
  masterSchoolName   String?
  masterGpa          Decimal?        @db.Decimal(5, 2)
  photoUrl           String?
  documents          Json            @default("[]")
  agentId            String?
  assignedTo         String?
  status             String          @default("Applicant")
  tags               String[]        @default([])
  metadata           Json            @default("{}")
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  applications       Application[]
  studentDocuments   Document[]      @relation("StudentToDocument")
  agent              Agent?          @relation(fields: [agentId], references: [id])
  timeline           TimelineEvent[]

  @@index([email])
  @@index([agentId])
  @@index([passportNumber])
  @@index([assignedTo])
  @@index([nationality])
  @@index([educationLevelId])
}

model Application {
  id              String          @id @default(cuid())
  studentId       String
  programId       String
  status          String          @default("New")
  priority        String          @default("Medium")
  applicationDate DateTime        @default(now())
  expectedIntake  String?
  estimatedValue  Decimal?        @db.Decimal(10, 2)
  assignedTo      String?
  tags            String[]        @default([])
  stageHistory    Json            @default("[]")
  metadata        Json            @default("{}")
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  program         Program         @relation(fields: [programId], references: [id])
  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  documents       Document[]
  tasks           Task[]
  timeline        TimelineEvent[]

  @@index([studentId])
  @@index([programId])
  @@index([status])
  @@index([assignedTo])
  @@index([applicationDate])
}

model Stage {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String   @default("#6366f1")
  order       Int
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
}

model Document {
  id            String       @id @default(cuid())
  applicationId String?
  studentId     String?
  leadId        String?
  fileName      String
  fileType      String
  fileUrl       String
  fileSize      Int?
  metadata      Json         @default("{}")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  student       Student?     @relation("StudentToDocument", fields: [studentId], references: [id], onDelete: Cascade)
  lead          Lead?        @relation("LeadToDocument", fields: [leadId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([studentId])
  @@index([leadId])
  @@index([fileType])
}

model TimelineEvent {
  id            String       @id @default(cuid())
  entityType    String
  entityId      String
  studentId     String?
  applicationId String?
  leadId        String?
  eventType     String
  title         String
  description   String       @db.Text
  metadata      Json         @default("{}")
  performedBy   String?
  createdAt     DateTime     @default(now())
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  student       Student?     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lead          Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([studentId])
  @@index([applicationId])
  @@index([leadId])
  @@index([createdAt])
}

model Task {
  id            String       @id @default(cuid())
  applicationId String?
  entityType    String?
  entityId      String?
  title         String
  description   String?
  dueDate       DateTime?
  priority      String       @default("Medium")
  status        String       @default("Open")
  assignedTo    String?
  createdBy     String?
  metadata      Json         @default("{}")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([entityType, entityId])
  @@index([assignedTo])
  @@index([dueDate])
  @@index([status])
}

model Webhook {
  id         String    @id @default(cuid())
  name       String
  event      String
  url        String
  method     String    @default("POST")
  headers    Json?
  payload    Json?
  isActive   Boolean   @default(true)
  lastRun    DateTime?
  lastStatus String?
  retryCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([event, isActive])
}

model AutomationRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String
  condition   Json?
  action      String
  actionData  Json
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([trigger, isActive])
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String
  name         String
  firstName    String?
  lastName     String?
  phone        String?
  profileImage String?
  role         String    @default("staff")
  avatar       String?
  isActive     Boolean   @default(true)
  lastLogin    DateTime?
  metadata     Json      @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  programs     Program[]
  
  // Agent/Sub-Agent fields
  agencyId       String?
  commissionRate Decimal?  @db.Decimal(5, 2)
  agency         Agent?    @relation(fields: [agencyId], references: [id])

  @@index([email])
  @@index([role])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String?
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}

model Lead {
  id                    String          @id @default(cuid())
  leadId                String?         @unique  // LEAD-0001, LEAD-0002, etc.
  type                  String          // "Student" or "Agent"
  status                String          @default("New")
  source                String?
  
  // Student Lead fields
  fullName              String?
  email                 String?
  phone                 String?
  country               String?
  preferredIntake       String?
  preferredCountries    String[]        @default([])
  budgetRange           String?
  
  // Agent Lead fields
  companyName           String?
  contactPerson         String?
  city                  String?
  estimatedStudents     Int?
  proposedCommission    Decimal?        @db.Decimal(5, 2)
  
  // Common fields
  notes                 String?         @db.Text
  assignedTo            String?
  convertedToStudentId  String?
  convertedToAgentId    String?
  metadata              Json            @default("{}")
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  leadDocuments         Document[]      @relation("LeadToDocument")
  timeline              TimelineEvent[]
  
  @@index([type])
  @@index([status])
  @@index([email])
  @@index([assignedTo])
  @@index([convertedToStudentId])
  @@index([createdAt])
}
