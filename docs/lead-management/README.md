Ø°# Lead Management Documentation

> **Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 2026-01-16  
> **Ø§Ù„Ø­Ø§Ù„Ø©:** âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Lead Module Ù…ÙƒØªÙ…Ù„ Ù…Ø¹ Backend Integration)

---

## ğŸ“š Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚

### 1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© (Overview)](./overview.md)
Ø´Ø±Ø­ Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© ÙÙŠ Lead Management

### 2. [Components Documentation](./components.md)
ØªÙˆØ«ÙŠÙ‚ ÙÙ†ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù€ components Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©

### 3. [Features Guide](./features-guide.md)
Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØµÙ„ Ù„ÙƒÙ„ Ù…ÙŠØ²Ø©

### 4. [Database Schema](./database-schema.md)
â­ **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹** - Ù…Ø®Ø·Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªÙ†ÙÙŠØ°

### 5. [Backend Requirements](./backend-requirements.md)
Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù€ Backend APIs ÙˆØ§Ù„Ù€ endpoints

### 6. [Permissions System](../permissions-system.md)
Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø·Ø· Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„

---

## ğŸ¯ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© (Summary)

### âœ… 1. Assigned To Dropdown
- ØªØºÙŠÙŠØ± Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù€ Lead
- Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†
- Frontend Ø¬Ø§Ù‡Ø² - ÙŠØ­ØªØ§Ø¬ API Ù„Ù„Ø­ÙØ¸

### âœ… 2. Notes Section
- Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù€ Lead
- Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
- Frontend Ø¬Ø§Ù‡Ø² - ÙŠØ­ØªØ§Ø¬ API Ù„Ù„Ø­ÙØ¸

### âœ… 3. Document Viewer
- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙŠ modal Ù…Ù†ÙØµÙ„
- Sidebar Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
- Navigation (Previous/Next)
- Frontend Ø¬Ø§Ù‡Ø² - ÙŠØ­ØªØ§Ø¬ file serving

### âœ… 8. Document Grid View â­ NEW
- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙŠ grid card layout Ø­Ø¯ÙŠØ«
- ØªØµÙ…ÙŠÙ… responsive (3 Ø£Ø¹Ù…Ø¯Ø©)
- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± (Image preview thumbnails)
- Ø£Ø²Ø±Ø§Ø± View Ùˆ Download Ù„ÙƒÙ„ Ù…Ø³ØªÙ†Ø¯
- ÙŠØ·Ø§Ø¨Ù‚ ØªØµÙ…ÙŠÙ… Student module
- Frontend Ø¬Ø§Ù‡Ø²

### âœ… 9. Lead Conversion â­ NEW
- ØªØ­ÙˆÙŠÙ„ Lead Ø¥Ù„Ù‰ Student
- Auto-redirect Ù„ØµÙØ­Ø© Edit Ø§Ù„Ø·Ø§Ù„Ø¨
- ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙŠ Timeline
- Frontend + Backend Ù…ÙƒØªÙ…Ù„

## Timeline Auto-Tracking

### Overview
All Lead operations are automatically tracked in the Timeline system with **detailed field-level change descriptions**.

### Tracked Operations

#### 1. **Lead Created**
- **Event Type**: `lead_created`
- **Title**: "Lead Created"
- **Description**: "New [Type] lead created: [Name]"
- **Metadata**: Lead ID, initial status, source

#### 2. **Lead Updated** âœ¨
- **Event Type**: `lead_updated`
- **Title**: "Lead Updated"
- **Description**: "[Name]: [Detailed Changes]"
- **Metadata**: Lead ID, changes object, detailed changes array, previous/new status

##### Tracked Fields (17 total):
- **Basic Info**: Status, Type, Name, Email, Phone, Country, City, Source
- **Student Fields**: Preferred Countries, Preferred Intake, Budget Range
- **University Fields**: Company Name, Contact Person
- **Agent Fields**: Estimated Students, Proposed Commission
- **Other**: Assigned To, Notes

##### Change Format:
```
"Field: Old Value â†’ New Value"
```

##### Examples:
```json
{
  "description": "Ahmed Ali: Status: New â†’ Contacted, Phone: None â†’ +20123456789",
  "detailedChanges": [
    "Status: New â†’ Contacted",
    "Phone: None â†’ +20123456789"
  ]
}
```

```json
{
  "description": "Sarah Student: City: Cairo â†’ Alexandria, Notes added",
  "detailedChanges": [
    "City: Cairo â†’ Alexandria",
    "Notes added"
  ]
}
```

#### 3. **Lead Deleted**
- **Event Type**: `lead_deleted`
- **Title**: "Lead Deleted"
- **Description**: "Lead deleted: [Name]"
- **Metadata**: Lead ID, final status

#### 4. **Lead Converted to Student**
- **Event Type**: `lead_converted`
- **Title**: "Lead Converted to Student"
- **Description**: "Lead [Name] converted to student [Student ID]"
- **Metadata**: Lead ID, Student ID
- **Note**: Creates TWO timeline events:
  1. On Lead timeline: `lead_converted`
  2. On Student timeline: `student_created_from_lead`

### Implementation Details

#### Backend Integration
Located: [`crm-backend/src/modules/leads/leads.service.ts`](../../crm-backend/src/modules/leads/leads.service.ts)

```typescript
// Automatic field comparison
const changes: string[] = [];

if (updateLeadDto.status && updateLeadDto.status !== existingLead.status) {
    changes.push(`Status: ${existingLead.status} â†’ ${updateLeadDto.status}`);
}
// ... 16 more fields

// Create timeline event
await this.timeline.createEvent({
    entityType: 'Lead',
    entityId: lead.id,
    eventType: 'lead_updated',
    title: 'Lead Updated',
    description: `${lead.fullName}: ${changes.join(', ')}`,
    metadata: {
        detailedChanges: changes
    }
});
```

### API Endpoints

#### Get Lead Timeline
```http
GET /api/timeline/Lead/:leadId?limit=10&offset=0
```

**Response:**
```json
[
  {
    "id": "evt_123",
    "entityType": "Lead",
    "entityId": "lead_456",
    "eventType": "lead_updated",
    "title": "Lead Updated",
    "description": "Ahmed Ali: Status: New â†’ Contacted, Phone: None â†’ +20123456789",
    "metadata": {
      "leadId": "LEAD-0001",
      "changes": {
        "status": "Contacted",
        "phone": "+20123456789"
      },
      "detailedChanges": [
        "Status: New â†’ Contacted",
        "Phone: None â†’ +20123456789"
      ]
    },
    "createdAt": "2026-01-19T12:00:00Z"
  }
]
```

### Special Handling

#### Null/Empty Values
- `null` â†’ displayed as "None"
- Empty string `""` â†’ displayed as "None" or "Not Set"
- Boolean fields use undefined check: `!== undefined`

#### Notes Field
- If notes added: "Notes added"
- If notes removed: "Notes removed"
- If notes updated: "Notes updated"

#### Array Fields
- Preferred Countries: Shows full value change

### Frontend Integration

#### Timeline Tab
Located: Lead detail page â†’ Timeline tab

Shows all events in reverse chronological order with:
- Event icon
- Event title
- Detailed description
- Timestamp
- Expandable metadata

### Benefits

1. **Complete Audit Trail**: Every change is logged with before/after values
2. **Clear Communication**: Team can see exactly what changed when
3. **Debugging**: Easy to track down when issues occurred
4. **Compliance**: Full history for regulatory requirements
5. **Analytics**: Can analyze lead journey and conversion patterns

---

## Best Practices

### When Creating Leads
### âœ… 4. Email Viewer
- Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
- Status tracking
- Frontend Ø¬Ø§Ù‡Ø² - ÙŠØ­ØªØ§Ø¬ email service integration

### âœ… 5. Document Actions
- Download individual documents
- Download all documents
- Delete documents
- Frontend Ø¬Ø§Ù‡Ø² - ÙŠØ­ØªØ§Ø¬ API endpoints

### âœ… 6. Task Management â­ NEW
- Ø¥Ù†Ø´Ø§Ø¡ tasks Ù„Ù„Ù€ lead (8 Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ©)
- Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯
- Expected Outcome Ù„ÙƒÙ„ task
- Status tracking (Pending, Completed, Cancelled)
- Overdue detection
- Frontend Ø¬Ø§Ù‡Ø² - ÙŠØ­ØªØ§Ø¬ API Ù„Ù„Ø­ÙØ¸

### âœ… 7. Rich Text Editor â­ NEW
- Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
- Formatting toolbar (Bold, Italic, Underline)
- Headings (H1, H2)
- Lists (Bullet, Numbered)
- Text Alignment
- Insert Links
- Frontend Ø¬Ø§Ù‡Ø²

---

## ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©/Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

### Components (New):
```
/components/leads/
â”œâ”€â”€ document-viewer.tsx       âœ¨ Ø¬Ø¯ÙŠØ¯
â”œâ”€â”€ email-viewer.tsx          âœ¨ Ø¬Ø¯ÙŠØ¯
â””â”€â”€ send-email-dialog.tsx     Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
```

### Pages (Modified):
```
/app/(dashboard)/leads/[id]/
â””â”€â”€ page.tsx                  ğŸ“ Ù…Ø¹Ø¯Ù„
```

### Data (Modified):
```
/lib/
â””â”€â”€ mock-data.ts              ğŸ“ Ù…Ø¹Ø¯Ù„ (Ø¥Ø¶Ø§ÙØ© mockUsers)
```

### Documentation (New):
```
/docs/
â”œâ”€â”€ permissions-system.md     âœ¨ Ø¬Ø¯ÙŠØ¯
â””â”€â”€ lead-management/          âœ¨ folder Ø¬Ø¯ÙŠØ¯
    â”œâ”€â”€ README.md             (Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù)
    â”œâ”€â”€ overview.md
    â”œâ”€â”€ components.md
    â”œâ”€â”€ features-guide.md
    â”œâ”€â”€ database-schema.md
    â””â”€â”€ backend-requirements.md
```

---

## ğŸš€ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ§Ù„ÙŠØ©

### Phase 1: Database Setup (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰)
- [ ] Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Database Ø­Ø³Ø¨ [database-schema.md](./database-schema.md)
- [ ] Ø¥Ø¶Ø§ÙØ© unique constraints (email, phone)
- [ ] Ø¥Ø¹Ø¯Ø§Ø¯ relationships Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
- [ ] Migration files

### Phase 2: Backend APIs
- [ ] Assignment APIs (GET, POST)
- [ ] Notes APIs (CRUD)
- [ ] Documents APIs (Upload, Download, Delete)
- [ ] Email integration (SendGrid/etc)

### Phase 3: Frontend Integration
- [ ] Ø±Ø¨Ø· Assigned To Ø¨Ù€ backend
- [ ] Ø±Ø¨Ø· Notes Ø¨Ù€ backend
- [ ] Ø±Ø¨Ø· Documents Ø¨Ù€ backend
- [ ] Real-time updates

### Phase 4: Permissions
- [ ] User roles implementation
- [ ] Permission checks
- [ ] Activity logging

---

## ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

| Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ | Ø§Ù„Ø­Ø§Ù„Ø© |
|---------|--------|
| **Components Ø¬Ø¯ÙŠØ¯Ø©** | 4 |
| **Features Ù…Ù†ÙØ°Ø©** | 9 |
| **Frontend Coverage** | 100% |
| **Backend Integration** | 60% (Conversion, Documents) |
| **Test Coverage** | Manual (Browser testing) |

---

## ğŸ¥ Ø§Ù„Ù€ Demos ÙˆØ§Ù„ØµÙˆØ±

### Document Viewer
![Document Viewer](/Users/mdarwish/.gemini/antigravity/brain/79bfdb5e-837c-4a30-8da0-5fabb21bd01f/document_viewer_modal_1768034684819.png)

### Email Viewer
![Email Viewer](/Users/mdarwish/.gemini/antigravity/brain/79bfdb5e-837c-4a30-8da0-5fabb21bd01f/email_viewer_modal_1768034750518.png)

### Assigned To Dropdown
![Assigned To](/Users/mdarwish/.gemini/antigravity/brain/79bfdb5e-837c-4a30-8da0-5fabb21bd01f/lead_assigned_to_dropdown_open_1768033177033.png)

---

## âš ï¸ Important Notes

### Ù„Ø§Ø²Ù… ØªØªØ¹Ù…Ù„ Ù‚Ø¨Ù„ Production:
1. **Backend Integration** - ÙƒÙ„ Ø§Ù„Ù€ features Ø¯ÙŠ frontend ÙÙ‚Ø·
2. **Database Schema** - Ø´ÙˆÙ [database-schema.md](./database-schema.md)
3. **File Storage** - Ù„Ù„Ù€ documents (S3, Cloudinary, etc)
4. **Email Service** - SendGrid Ø£Ùˆ Resend
5. **Permissions** - Ø´ÙˆÙ [permissions-system.md](../permissions-system.md)

### Security Considerations:
1. Validate all file uploads
2. Implement rate limiting
3. Add CSRF protection
4. Sanitize user inputs
5. Implement proper authentication

---

## ğŸ“ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©

Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø£ÙŠ featureØŒ Ø´ÙˆÙ:
- [Features Guide](./features-guide.md) - Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
- [Components Documentation](./components.md) - Ù„Ù„ØªØ·ÙˆÙŠØ±
- [Backend Requirements](./backend-requirements.md) - Ù„Ù„Ù€ APIs

---

**Created by:** Antigravity AI  
**Date:** 2026-01-10  
**Version:** 1.0.0
